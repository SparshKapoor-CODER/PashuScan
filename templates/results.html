<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results</title>
    <link rel="stylesheet" href="/static/results.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&amp;display=swap" rel="stylesheet">
</head>

<body>
    <nav>
        <div class="logo">
            <a href="/templates/index.html"><img src="{{ url_for('static', filename='logo.png') }}" alt=""></a>
        </div>
    </nav>

    <div class="main">
        <div class="rect">

        </div>
        <div class="content">
            <h1 id="resultsTitle">Results Screen</h1>
            <div class="cont-down">
                <div class="cont-rect">
                </div>
                <div class="cont-details">
                    <div id="breedName">Breed Name: </div>
                    <div id="confidenceScore">Confidence Score: </div>
                    <div id="keyBreedInfo">Measurements: No measurements found.</div>
                    <button class="save" id="saveBtn">Save to Logbook</button>
                </div>
            </div>
            <button class="try" id="tryBtn">Try Again</button>
        </div>
    </div>
    <script>
document.addEventListener('DOMContentLoaded', async function () {
  // get the prediction result (prefer sessionStorage, else fallback to /results)
  let data = null;
  try {
    const raw = sessionStorage.getItem('lastResult');
    if (raw) data = JSON.parse(raw);
    if (!data) {
      const r = await fetch('/results');
      if (r.ok) data = await r.json();
    }
  } catch (e) {
    console.error('Error loading result:', e);
  }

  // helper for language labels
  function t(key) {
    const lang = localStorage.getItem('language') || 'english';
    const map = {
      english: {
        breedName: 'Breed Name:',
        confidenceScore: 'Confidence Score:',
        keyBreedInfo: 'Measurements:',
        setCalib: 'Set calibration (cm per px):',
        applyCalib: 'Apply',
        saveBtn: 'Save to Logbook',
        tryBtn: 'Try Again'
      },
      hindi: {
        breedName: 'नस्ल का नाम:',
        confidenceScore: 'विश्वास स्कोर:',
        keyBreedInfo: 'माप:',
        setCalib: 'कैलिब्रेशन दर्ज करें (सेमी/px):',
        applyCalib: 'लागू करें',
        saveBtn: 'लॉगबुक में सहेजें',
        tryBtn: 'फिर प्रयास करें'
      }
    };
    return (map[lang] && map[lang][key]) || map.english[key];
  }

  // show top prediction
  if (data && data.predictions && data.predictions.length > 0) {
    const best = data.predictions[0];
    document.getElementById('breedName').innerText = `${t('breedName')} ${best.breed || 'N/A'}`;
    const conf = Number(best.confidence);
    document.getElementById('confidenceScore').innerText = `${t('confidenceScore')} ${conf <= 1 ? (conf*100).toFixed(2) + '%' : conf}`;
  }

  // measurements block
  const measBlock = document.getElementById('keyBreedInfo');
  function showNoMeas() {
    measBlock.innerText = t('keyBreedInfo') + ' No measurements found.';
  }

  const measurements = data && data.measurements ? data.measurements : null;
  if (!measurements) {
    showNoMeas();
  } else {
    // Render px / computed cm / angle / positions
    measBlock.innerHTML = `<strong>${t('keyBreedInfo')}</strong>`;
    const table = document.createElement('div');
    table.className = 'measurements-table';
    table.style.marginTop = '8px';
    table.style.whiteSpace = 'pre-wrap';

    // helper to append row with px and cm if available
    function appendRow(name, pxValue, cmValue) {
      const row = document.createElement('div');
      row.className = 'measurement-row';
      row.setAttribute('data-measurement', name);
      let text = `${name}: `;
      if (pxValue != null) text += `${pxValue} px`;
      if (cmValue != null) text += `  —  ${cmValue} cm`;
      row.innerText = text;
      table.appendChild(row);
    }

    appendRow('body_length', measurements.body_length_px, measurements.body_length_cm);
    appendRow('height', measurements.height_px, measurements.height_cm);
    appendRow('contour_area', measurements.contour_area_px, measurements.contour_area_px ? `${measurements.contour_area_px} px^2` : null);
    appendRow('rump_angle', measurements.rump_angle, null);
    if (measurements.tailhead_position) {
      appendRow('tailhead_position', `[${measurements.tailhead_position.join(', ')}]`, null);
    }
    if (measurements.withers_position) {
      appendRow('withers_position', `[${measurements.withers_position.join(', ')}]`, null);
    }

    // calibration info
    const calibRow = document.createElement('div');
    calibRow.className = 'calibration-info';
    calibRow.style.marginTop = '10px';
    const calibVal = measurements.calibration_factor_cm_per_px || null;
    calibRow.innerHTML = `Calibration (cm/px): ${calibVal !== null ? calibVal : '<em>not set</em>'}`;
    table.appendChild(calibRow);

    // show input to set calibration client-side
    const inputRow = document.createElement('div');
    inputRow.className = 'calibration-input-section';
    inputRow.style.marginTop = '8px';
    inputRow.innerHTML = `
      <label class="calibration-label">${t('setCalib')}</label>
      <input id="calibInput" class="calibration-input" type="number" step="any" placeholder="e.g. 0.02" style="width:120px"/>
      <button id="calibApply" class="calibration-apply-btn">${t('applyCalib')}</button>
      <div id="calibMsg" class="calibration-message" style="margin-top:6px;color: #555;"></div>
    `;
    table.appendChild(inputRow);

    measBlock.appendChild(table);

    // apply calibration (compute cm from px client-side and keep in-memory 'data' updated)
    document.getElementById('calibApply').addEventListener('click', function () {
      const v = parseFloat(document.getElementById('calibInput').value);
      const msg = document.getElementById('calibMsg');
      if (!v || isNaN(v) || v <= 0) {
        msg.innerText = 'Enter a valid positive number.';
        return;
      }
      // update the measurement cm fields using px * v
      if (measurements.body_length_px) measurements.body_length_cm = (measurements.body_length_px * v).toFixed(2);
      if (measurements.height_px) measurements.height_cm = (measurements.height_px * v).toFixed(2);
      measurements.calibration_factor_cm_per_px = v;
      // persist calibration locally for later use (optional)
      localStorage.setItem('last_calibration_cm_per_px', v);
      msg.innerText = `Calibration applied. body_length_cm=${measurements.body_length_cm} cm`;
      // re-render updated values by reloading the page (quick) or by updating DOM directly:
      // For simplicity, update DOM by setting text again:
      // (We simply reload the page to show the changes)
      sessionStorage.setItem('lastResult', JSON.stringify(data));
      // re-run this block to re-render with computed cm
      location.reload();
    });
  }

  // Save button - include measurements (including any computed cm)
  document.getElementById('saveBtn').addEventListener('click', async function () {
    if (!data || !data.image_url) { alert('Nothing to save'); return; }
    const payload = {
      image_url: data.image_url,
      classification: data.predictions && data.predictions[0] ? data.predictions[0] : {},
      measurements: data.measurements || {},
      metadata: { saved_at: new Date().toISOString() }
    };
    try {
      const r = await fetch('/save_evaluation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (r.ok) {
        alert('Saved to logbook');
        // store lastResult in sessionStorage (so the saved data matches UI)
        sessionStorage.setItem('lastResult', JSON.stringify(data));
        window.location.href = 'logbook.html';
      } else {
        alert('Save failed: ' + (j.error || JSON.stringify(j)));
      }
    } catch (err) {
      console.error('Save failed', err);
      alert('Save failed. See console.');
    }
  });

  // Try again
  document.getElementById('tryBtn').addEventListener('click', () => {
    window.location.href = 'home.html';
  });

});
</script>
</body>
</html>
